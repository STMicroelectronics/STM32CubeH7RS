## <b>OEMiROT_Boot application Description</b>

This project provides an OEMiROT boot example.

OEMiRoT stands for OEM immutable (unchangeable) Root of Trust and acts as a first boot stage. OEMiRoT is an example based on the MCUboot open-source software. OEMiRoT offers two services:

- The Secure Boot (root of trust service) is an immutable code, which is always executed after a system reset. It checks static protections (options bytes),
  activates runtime protections, and then verifies the authenticity and integrity of the user application code before every execution.
- The Secure Firmware Update application is an immutable code that detects new firmware image candidate. It checks its version (version downgrade prevention),
  authenticity, and integrity before installing it after decryption.

An OEM updatable RoT (OEMuRoT) can be generated by compiling OEMiRoT_Boot project with OEMUROT_ENABLE switch activated. OEMuRoT acts as a second boot stage after STiRoT,
and provides the same two services: Secure Boot and Secure Firmware Update. Both OEMiRoT and OEMuRoT examples are generated based on OEMiRoT_Boot project with the switch OEMUROT_ENABLE
activated or not.

To ease the development process, a prebuild command and postbuild command are integrated in the project.
The prebuild command is in charge of preparing the OEMiROT_Boot scatter file according to flash layout description.
The postbuild command is in charge of preparing the provisioning scripts and the application image (firmware application managed by OEMiROT) configuration files in ROT_Provisioning/OEMiROT
folder, according to the flash layout and OEMiROT configuration.

The system clock is set to 380 MHz to be functional with all hardware configurations (ECC_ON_SRAM enabled, no internal regulator)
and with the full range of temperature (Tj up to 125Â°). In other circumstances, the system clock can be increased up to 600 Mhz.

### <b>Keywords</b>

OEMiROT, Boot path, Root Of Trust, Security, mcuboot

### <b>Directory contents</b>

File | Description
 --- | ---
  OEMiROT_Boot/Inc/mcuboot_config/mcuboot_config.h |  Mcuboot configuration file
  OEMiROT_Boot/Inc/boot_hal_cfg.h                  |  Platform configuration file for OEMiROT_Boot
  OEMiROT_Boot/Inc/boot_hal_flowcontrol.h          |  Header file for flow control code in boot_hal.c
  OEMiROT_Boot/Inc/boot_hal_hash_ref.h             |  Header file for hash reference code in boot_hal.c
  OEMiROT_Boot/Inc/boot_hal_imagevalid.h           |  Header file for image validation code in boot_hal.c
  OEMiROT_Boot/Inc/boot_hal_mce.h                  |  Header file for MCE code in boot_hal.c
  OEMiROT_Boot/Inc/cmsis.h                         |  Header file for CMSIS
  OEMiROT_Boot/Inc/flash_layout.h                  |  Flash mapping
  OEMiROT_Boot/Inc/low_level_ext_flash.h           |  Header file for low_level_ext_flash.c
  OEMiROT_Boot/Inc/low_level_ext_ram.h             |  Header file for low_level_ext_ram.c
  OEMiROT_Boot/Inc/low_level_flash.h               |  Header file for low_level_flash.c
  OEMiROT_Boot/Inc/low_level_mce.h                 |  Header file for low_level_mce.c
  OEMiROT_Boot/Inc/low_level_obkeys.h              |  Header file for low_level_obkeys.c
  OEMiROT_Boot/Inc/low_level_ramecc.h              |  Header file for low_level_ramecc.c
  OEMiROT_Boot/Inc/low_level_rng.h                 |  Header file for low_level_rng.c
  OEMiROT_Boot/Inc/low_level_security.h            |  Header file for low_level_security.c
  OEMiROT_Boot/Inc/mbedtls_config.h                |  Mbed-crypto configuration file
  OEMiROT_Boot/Inc/region_defs.h                   |  RAM and FLASH regions definitions
  OEMiROT_Boot/Inc/stm32_extmem_conf.h             |  STM32_ExtMem_Manager configuration file
  OEMiROT_Boot/Inc/stm32h7rsxx_hal_conf.h          |  HAL driver configuration file
  OEMiROT_Boot/Inc/target_cfg.h                    |  Header file for target start up
  OEMiROT_Boot/Src/bl2_nv_services.c               |  Non Volatile services for OEMiROT_Boot
  OEMiROT_Boot/Src/boot_hal.c                      |  Platform initialization
  OEMiROT_Boot/Src/image_macros_to_preprocess_bl2.c |  Image definitions to preprocess for bl2
  OEMiROT_Boot/Src/keys_map.c                      |  keys indirection to access keys in OBKeys area
  OEMiROT_Boot/Src/low_level_com.c                 |  UART low level interface
  OEMiROT_Boot/Src/low_level_device.c              |  Flash Low level device configuration
  OEMiROT_Boot/Src/low_level_ext_flash.c           |  External Flash Low level interface
  OEMiROT_Boot/Src/low_level_ext_ram.c             |  External RAM Low level interface
  OEMiROT_Boot/Src/low_level_extmem_device.c       |  External Memory Low level device configuration
  OEMiROT_Boot/Src/low_level_flash.c               |  Flash Low level interface
  OEMiROT_Boot/Src/low_level_mce.c                 |  MCE Low level interface
  OEMiROT_Boot/Src/low_level_obkeys.c              |  OBKEY Low level interface
  OEMiROT_Boot/Src/low_level_obkeys_device.c       |  OBKEY Low level device configuration
  OEMiROT_Boot/Src/low_level_ramecc.c              |  RAMECC Low level interface
  OEMiROT_Boot/Src/low_level_rng.c                 |  Random generator interface
  OEMiROT_Boot/Src/low_level_security.c            |  Security Low level services
  OEMiROT_Boot/Src/startup_stm32h7rsxx.c           |  Startup file in c
  OEMiROT_Boot/Src/stm32h7rsxx_hal_msp.c           |  HAL MSP module
  OEMiROT_Boot/Src/system_stm32h7rsxx.c            |  System Init file
  OEMiROT_Boot/Src/tick.c                          |  HAL Tick implementation

### <b>Hardware and Software environment</b>

  - This example runs on STM32H7S7xx devices.

  - This example has been tested with STMicroelectronics STM32H7S78-DK (MB1736) board and can be easily tailored for
    STM32H7R7xx devices by following these steps
    (more details in the wiki article [<b>How to create ROT examples for STM32H7RS</b>](https://wiki.st.com/stm32mcu/wiki/Security:How_to_create_ROT_examples_for_STM32H7RS)).

  - To get debug print in your UART console you have to configure it using these parameters:
    Speed: 115200, Data: 8bits, Parity: None, stop bits: 1, Flow control: none.


### <b>How to use it ?</b>

<u>Before compiling the project, you should first start the provisioning process</u>. During the provisioning process,
the OEMUROT_ENABLE switch will be automatically configured according to bootpath.

Before starting the provisioning process, select the application project to use (application example or template),
through oemirot_boot_path_project variable in ROT_Provisioning/env.bat or env.sh.
Then start provisioning process by running provisioning.bat (.sh) from ROT_Provisioning/OEMiROT or ROT_Provisioning/STiROT_OEMuROT,
and follow its instructions. Refer to ROT_Provisioning/OEMiROT or ROT_Provisioning/STiROT_OEMuROT readme for more information on
the provisioning process for OEMiROT boot path or STiROT_OEMuROT boot path.

If the product state is set to PROVISIONING or CLOSED, it is still possible to open the debug or to execute a regression
with the Debug Authentication feature. To do it, scripts (regression.bat (.sh) & dbg_auth.bat (.sh)) are available in the ROT_provisioning/DA folder.

Refer to OEMiROT_Appli readme for example of application booted through OEMiROT boot path (or through
STiROT_OEMuROT boot path).

For more details, refer to STM32H7RS Wiki articles:

  - [OEMiRoT OEMuRoT for STM32H7S](https://wiki.st.com/stm32mcu/wiki/Security:OEMiRoT_OEMuRoT_for_STM32H7S).
  - [How to start with OEMiRoT on STM32H7S](https://wiki.st.com/stm32mcu/wiki/Security:How_to_start_with_OEMiRoT_on_STM32H7S).
  - [How to start with STiRoT OEMuRoT on STM32H7S](https://wiki.st.com/stm32mcu/wiki/Security:How_to_start_with_STiRoT_OEMuRoT_on_STM32H7S).

#### <b>Notes:</b>

By default the anti-tamper is enabled for internal tamper events only. It is possible to change this configuration with
OEMIROT_TAMPER_ENABLE define in Inc\\boot_hal_cfg.h.

```
#define NO_TAMPER            (0)                   /*!< No tamper activated */
#define INTERNAL_TAMPER_ONLY (1)                   /*!< Only Internal tamper activated */
#define ALL_TAMPER           (2)                   /*!< Internal and External tamper activated */
#define OEMIROT_TAMPER_ENABLE INTERNAL_TAMPER_ONLY /*!< TAMPER configuration flag  */
```

If OEMIROT_TAMPER_ENABLE is changed to ALL_TAMPER, the anti-tamper protection is enabled with active tamper pins usage.
It is needed to connect TAMP_IN2 (PB9 on CN3 pin 10) and TAMP_OUT8 (PC1 on CN11 pin 6) on the STM32H7S78-DK board,
to allow the application to run. In case the tamper pins are opened or shorted, then the application is reset and blocked.
Moreover, no warning message about anti-tamper detection will be displayed if the product state is set to CLOSED or LOCKED,
even with OEMIROT_DEV_MODE enabled.

### <b>Restrictions:</b>

For STM32H7S7xx devices, with STM32CubeIDE, the following configuration is not supported due to 64Kbytes internal flash limitation:

   - OEMUROT_ENABLE undefined, MCUBOOT_OVERWRITE_ONLY undefined.
